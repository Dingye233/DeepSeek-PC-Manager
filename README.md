# DeepSeek-PC-Manager

基于DeepSeek大语言模型的智能助手系统，提供多种功能，包括文本交互、语音识别与合成、代码生成、邮件管理、天气查询等。

---

## 系统特性 | System Features

### 智能任务验证系统 | Intelligent Task Verification System

DeepSeek-PC实现了一套严格的任务验证机制，确保用户请求被真正执行而非仅停留在计划阶段：

1. **计划与执行严格区分**
   - 系统能够明确区分"计划做什么"和"已经做了什么"
   - 仅将有明确工具调用证据的步骤视为已完成
   - 防止大模型将任务描述误认为已执行操作

2. **证据驱动的完成判断**
   - 任务完成状态基于实际工具调用记录而非模型自我评估
   - 为每个关键步骤收集执行证据，包括工具名称、目的和结果
   - 自动计算成功执行的工具调用比例，作为任务完成度的客观指标

3. **幻觉风险评估**
   - 实时监控并评估模型将计划误认为执行的风险
   - 对高风险幻觉场景进行明确警告和强制纠正
   - 通过执行差距分析，揭示计划与实际执行间的差异

4. **递进式验证机制**
   - 在执行前、执行过程中和执行后进行多层次验证
   - 追踪任务进度变化，及时发现进度停滞或倒退的情况
   - 支持多次验证尝试，确保验证结果的可靠性

5. **智能任务状态识别**
   - 清晰标记任务状态为[完成]/[失败]/[继续]，明确任务执行结果
   - 自动识别任务失败情况，提供详细的失败原因和可能的解决方案
   - 检测部分完成但已达到可接受状态的任务，支持灵活的完成判断
   - 进度监控系统，自动检测连续多次无进展的执行，避免无效循环

6. **动态任务规划能力**
   - 在每次迭代中重新评估任务进展并动态调整计划
   - 不再机械地按初始计划执行，而是根据实际情况灵活调整
   - 评估当前任务进展百分比，为用户提供清晰的进度反馈
   - 主动识别执行障碍并提出调整方案，增强解决问题的能力

7. **深度验证与虚假成功检测**
   - 智能检测"看似成功但实际未完成"的情况（如无变更推送、空操作）
   - 分析工具调用输出中的可疑模式，自动识别常见错误信号
   - 对任务完成声明进行严格的二次验证，确认每个步骤都真正达到了预期效果
   - 针对可疑执行结果，提供具体的纠正指导，引导智能体继续完成任务

8. **用户确认机制**
   - 在任务可能失败时主动询问用户是否继续尝试
   - 不再由AI单方面决定任务失败，而是将决策权交还给用户
   - 支持开放式用户输入，用户可以提供补充信息或新的解决思路
   - 即使AI认为任务无法完成，也会根据用户意愿尝试新的解决方案
   - 提供全新思路和创新方案，避免过早放弃复杂任务

此验证系统大幅提高了任务执行的可靠性，确保用户请求被真正执行完成，而非仅仅获得一个未实际执行的计划或描述。

---

## 功能模块

### 核心功能

- **文本对话**：与大语言模型实时交互
- **语音识别与合成**：支持语音输入和输出（仅完整版本）
- **自主任务规划**：AI自动分解复杂任务并执行
- **智能任务验证**：严格区分计划与执行，通过工具调用证据验证任务完成度
- **动态任务调整**：根据实际执行情况实时调整后续步骤，不机械遵循初始计划
- **幻觉防护机制**：实时评估和防止模型将计划误认为已执行的操作
- **错误处理与修复**：自动检测执行错误并尝试修复
- **上下文理解**：保持对话上下文连续性
- **任务状态管理**：清晰区分任务完成、失败或继续执行的状态
- **自动突破困境**：检测到任务卡壳时自动尝试创新解决方案
- **用户决策参与**：在任务可能失败时询问用户意见，支持开放式输入，用户可提供补充信息或新思路

### 工具集成

- **文件操作**：创建、读取、修改文件 (`code_generator.py`)
- **代码生成器**：编写、验证和管理代码文件 (`code_generator.py`)
- **系统命令执行**：
  - **PowerShell命令**：通过PowerShell控制系统 (`powershell_command`)
  - **CMD命令**：通过命令提示符执行DOS命令 (`cmd_command`)
- **邮件收发**：检查邮箱和发送邮件 (`send_email.py`)
- **天气查询**：获取城市实时天气信息 (`get_weather`)
- **SSH控制**：管理远程服务器 (`ssh_controller.py`)
- **深度思考**：使用R1优化器解决复杂问题 (`R1_opt`)

---

## 系统要求

- **操作系统**: Windows 10/11
- **Python**: 3.8+
- **主要依赖**: 
  - `openai` - OpenAI API客户端
  - `edge-tts` - 文本转语音
  - `python-dotenv` - 环境变量管理
  - `pyaudio` - 音频处理
  - `tiktoken` - Token计数
  - 完整列表见`requirements.txt`

---

## 使用说明

### 基础版本 (无语音功能)

```bash
python deepseekAPI.py
```

### 完整版本 (带语音功能)

```bash
python aaaa.py
```

或双击`start_voice_mode.bat`

### 交互方式

- **基础版本**: 仅支持文字输入/输出
- **完整版本**: 支持语音输入(连续1.5秒静音自动结束)和语音输出(自动将回复转为语音)

---

## 代码工具功能

本项目集成了代码生成和管理工具，无需使用PowerShell命令即可操作代码文件：

### 可用工具

1. **write_code** - 将代码写入文件
   ```python
   {
     "file_name": "example.py",  # 文件路径和名称
     "code": "print('Hello World')"  # 代码内容
   }
   ```

2. **verify_code** - 验证Python代码语法
   ```python
   {
     "code": "def example(): return 42"  # 要验证的Python代码
   }
   ```

3. **append_code** - 向文件追加代码
   ```python
   {
     "file_name": "example.py",  # 要追加的文件
     "content": "\ndef new_function():\n    pass"  # 要追加的内容
   }
   ```

4. **read_code** - 读取文件内容
   ```python
   {
     "file_name": "example.py"  # 要读取的文件
   }
   ```

5. **create_module** - 创建Python模块
   ```python
   {
     "module_name": "utils",  # 模块名称（不含.py）
     "functions_json": '[{"name": "add", "params": "a, b", "body": "return a + b", "docstring": "Add two numbers"}]'  # 函数定义JSON
   }
   ```

### 代码工具示例

可以运行代码生成器示例：

```bash
python -c "import code_tools; print(code_tools.write_code('hello_world.py', 'print(\"Hello, AI generated World!\")\n'))"
```

或双击`code_generator_demo.bat`

---

## 常见问题

1. **PyAudio安装失败**：
   - Windows: 下载预编译wheel文件安装
   - Linux: 安装系统依赖 `sudo apt-get install python3-pyaudio portaudio19-dev`
   - macOS: 使用Homebrew安装 `brew install portaudio`

2. **API密钥配置**：
   - 确保.env文件中的API密钥已正确配置
   - DeepSeek API密钥需要在[DeepSeek官网](https://platform.deepseek.com/)申请

3. **语音功能不工作**：
   - 检查麦克风和扬声器设置
   - 确保pyaudio和edge-tts正确安装
   - 语音识别需要网络连接

4. **依赖安装问题**：
   - 尝试使用国内镜像源: `pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple`

---

## 项目结构

```
├── README.md
├── aaaa.py                # 完整版本(含语音功能)
├── deepseekAPI.py         # 基础版本(仅文本功能)
├── tool_registry.py       # 集中式工具定义模块
├── system_utils.py        # 系统工具和命令执行功能
├── code_generator.py      # 代码生成工具
├── code_tools.py          # 代码操作工具集
├── file_utils.py          # 文件操作工具集
├── send_email.py          # 邮件发送功能
├── ssh_controller.py      # SSH远程控制
├── error_utils.py         # 错误处理工具
├── message_utils.py       # 消息处理工具
└── requirements.txt       # 依赖列表
```

---

## 最近更新

### 2023年5月更新

1. **用户确认任务失败机制**
   - 新增智能体任务失败前的用户确认步骤
   - 当AI认为任务无法完成时，会询问用户是否继续尝试
   - 用户可以提供开放式输入，补充说明或提供额外信息
   - 无需局限于简单的"继续/终止"选择，可以直接描述新思路或确认方向
   - 默认继续尝试而非放弃，增强解决复杂问题的能力

2. **错误处理机制优化**
   - 更精细的错误分类和处理策略
   - 在用户选择继续尝试后，自动分析失败原因并制定新方案
   - 多样化突破思路，包括问题拆解和替代方案探索
   - 增强系统韧性，减少过早放弃复杂任务的情况

3. **任务复杂度自适应验证**
   - 引入任务复杂度识别系统，自动区分简单命令和复杂任务
   - 对git操作、文件列表等简单任务减少验证次数
   - 自动识别成功信号，对简单任务执行快速验证
   - 显著提高了常见命令操作的响应速度

4. **控制台输出智能处理**
   - 优化命令输出结果处理逻辑，根据文本量自动调整返回方式
   - 当输出少于5000字符时，直接返回完整原始输出
   - 当输出超过5000字符时，自动调用LLM生成简洁摘要

### 用户交互示例

当智能体遇到无法解决的任务时，系统会询问用户：

```
智能体认为任务无法完成。您是否希望继续尝试，或者有其他建议？
(输入您的想法或指示，不限于简单的继续/终止选择)
```

用户可以提供开放式回复，例如：
- "继续尝试，但尝试使用另一种方法"
- "你尝试帮我解决一下网络问题吧"
- "改用Python 3.8版本试试看"
- "查看日志文件了解更多错误信息"

系统会根据用户的具体输入调整解决方案，而不仅限于继续或终止的二元选择。

### 2025年4月更新

1. **通用任务成功检测机制**
   - 实现了更通用的任务成功检测系统，不再依赖特定工具类型
   - 使用通用成功信号和错误信号列表，适用于所有工具执行结果
   - 当检测到成功信号且不存在错误信号时，由模型评估任务完成状态
   - 确认完成后立即生成简洁总结并结束任务，大幅减少Token消耗
   - 优化了任务执行流程，避免不必要的验证步骤，提高响应速度

2. **增强的任务验证系统**
   - 增强了智能验证机制，防止虚假任务完成报告
   - 添加了对多种可疑输出模式的自动识别
   - 对任务完成声明进行二次深度验证
   - 系统能够检测"看似完成但实际未完成"的情况

3. **提高智能体韧性**
   - 增加了任务执行的最大尝试次数（从5次到7次）
   - 放宽了进度停滞的判断条件（从3次到5次）
   - 添加了"突破困境"功能，在任务卡壳时提供新思路
   - 更谨慎的任务失败判断，引导智能体多尝试不同解决方案

4. **CMD命令工具**
   - 新增CMD命令工具，用于执行传统DOS命令和批处理文件
   - 自动设置UTF-8编码，更好地支持中文显示
   - 智能响应确认提示，无需手动添加/Y等参数
   - 与PowerShell工具相同的自动交互能力和结果摘要

5. **工具注册模块改进**
   - 集中式工具注册模块，减少代码重复
   - 更详细的工具描述和用法说明
   - 统一的参数验证和错误处理

6. **任务执行机制优化**
   - 更严格的前置任务依赖检查
   - 智能分析工具调用结果，而非仅检查命令执行
   - 动态生成任务执行计划，不再机械按初始计划执行
   - 递增式任务验证，确保每个步骤都真正完成

---

## 许可证

本项目采用MIT许可证。详情请参阅LICENSE文件。

---

## 联系方式

如有问题或建议，请通过以下方式联系我们：

- 邮箱: support@deepseek-pc.example.com
- GitHub: https://github.com/yourusername/deepseek-pc-manager

---

感谢使用DeepSeek-PC-Manager！希望它能成为您的得力助手。
